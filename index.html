<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Voice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <script src="annyang.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SpeechKITT/0.3.0/speechkitt.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body {
            padding-top: 20px;
        }

        #notesContainer {
            margin-top: 20px;
            background-color: #f8f9fa;
        }

        .note {
            border: 1px solid #ccc;
            margin-top: 5px;
            padding: 8px;
            border-radius: 4px;
        }
    </style>
</head>

<body class="p-3">
    <ul id="notebookTabs" class="nav nav-tabs"></ul>
    <button id="createNotebookButton" class="btn btn-primary mt-3">Add Notebook</button>
    <div class="input-group mt-3">
        <input type="text" id="noteInput" class="form-control" placeholder="Enter a note">
        <button id="addNoteButton" class="btn btn-secondary">Add Note</button>
    </div>
   
    <div id="notesContainer" class=""></div>
    <script>
        function saveActiveTabUID(uid) {
            localStorage.setItem('activeTabUID', uid);
        }
        function setActiveTab(notebookId) {
            const notebookTabs = document.querySelectorAll('.nav-link');
            notebookTabs.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.notebookId === notebookId) {
                    link.classList.add('active');
                }
            });

            if (notebookId) {
                loadNotes(notebookId);
                saveActiveTabUID(notebookId); // Ensure this is called whenever the active tab is set
            }
        }


        // Function to retrieve the active tab's UID from local storage
        function getActiveTabUID() {
            return localStorage.getItem('activeTabUID');
        }
        const firebaseConfig = {
            databaseURL: "https://voice-noter-default-rtdb.europe-west1.firebasedatabase.app",
        };

        firebase.initializeApp(firebaseConfig);
        let userId = sessionStorage.getItem('userId') || generateUserId();

        function generateUserId() {
            const newId = Date.now().toString(36) + Math.random().toString(36).substr(2);
            sessionStorage.setItem('userId', newId);
            return newId;
        }

        document.addEventListener('DOMContentLoaded', function () {
            loadUserNotebooks();
            document.getElementById('addNoteButton').addEventListener('click', addNoteFromInput);
            document.getElementById('createNotebookButton').addEventListener('click', createNotebook);
         });


        function addNoteFromInput() {
            const noteContent = document.getElementById('noteInput').value;
            const notebookId = document.querySelector('.nav-link.active')?.dataset.notebookId;
            if (noteContent && notebookId) {
                addNote(noteContent, notebookId);
                document.getElementById('noteInput').value = ''; // Clear the input after adding a note
            }
        }
        function loadUserNotebooks() {
            const userNotebooksRef = firebase.database().ref(`users/${userId}/notebooks`);
            userNotebooksRef.once('value', snapshot => {
                const notebooks = snapshot.val();
                console.log("Notebooks fetched: ", notebooks); // Debug output

                if (notebooks && Object.keys(notebooks).length > 0) {
                    Object.keys(notebooks).forEach((notebookId, index) => {
                        createTab(notebookId, index === 0); // Set the first tab as active by default
                    });

                    const activeTabUID = getActiveTabUID();
                    if (activeTabUID) {
                        setActiveTab(activeTabUID);
                    } else {
                        setActiveTab(Object.keys(notebooks)[0]);
                    }
                } else {
                    console.log("No notebooks found, creating one..."); // Debug output
                    createNotebook(); // Only create a new notebook if none are found
                }
            }, error => {
                console.error("Failed to fetch notebooks:", error); // Error handling
            });
        }

        function createNotebook() {
            const newNotebookRef = firebase.database().ref(`users/${userId}/notebooks`).push();
            newNotebookRef.set({ createdAt: Date.now() }, function (error) {
                if (!error) {
                    createTab(newNotebookRef.key, true); // Also set this new notebook as active
                }
            });
        }


        function createTab(notebookId, setActive = false) {
            var tab = document.createElement('li');
            tab.className = 'nav-item';
            var link = document.createElement('a');
            link.className = 'nav-link';
            link.href = '#';
            link.textContent = `${notebookId}`;
            link.dataset.notebookId = notebookId;
            link.onclick = function () {
                document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                loadNotes(notebookId);
                saveActiveTabUID(notebookId); // Save the active tab UID whenever a tab is clicked
                return false;
            };
            tab.appendChild(link);
            document.getElementById('notebookTabs').appendChild(tab);
            if (setActive) {
                link.click(); // Automatically click the link to set it as active if specified
            }
        }
        function loadNotes(notebookId) {
            var notebookNotesRef = firebase.database().ref(`users/${userId}/notebooks/${notebookId}/notes`);
            notebookNotesRef.on('value', function (snapshot) {
                const notes = snapshot.val() || {};
                document.getElementById('notesContainer').innerHTML = '';
                Object.keys(notes).forEach(noteId => {
                    var noteElement = document.createElement('div');
                    noteElement.className = 'note';
                    noteElement.textContent = notes[noteId].content;
                    document.getElementById('notesContainer').appendChild(noteElement);
                });
            });
        }

        function addNote(content, notebookId) {
            console.log(`Attempting to add note to notebook ${notebookId}: ${content}`); // Debug output
            var newNoteRef = firebase.database().ref(`users/${userId}/notebooks/${notebookId}/notes`).push();
            newNoteRef.set({ content: content, createdAt: Date.now() }, error => {
                if (error) {
                    console.error('Failed to add note:', error);
                } else {
                    console.log('Note added successfully');
                }
            });
        }
        function setupVoiceRecognition() {
            if (annyang) {
                annyang.setLanguage('cs'); // Set the desired language
        
                let capturedText = ""; // This will hold the ongoing speech capture
                let silenceTimer; // Timer to handle the end of speaking
        
                // Function to handle final processing of captured text
                const processCapturedText = () => {
                    const notebookId = document.querySelector('.nav-link.active')?.dataset.notebookId;
                    if (notebookId && capturedText.trim() !== "") {
                        addNote(capturedText, notebookId);
                        console.log("Note added:", capturedText);
                        capturedText = ""; // Reset the captured text after processing
                    }
                };
        
                // Start capturing speech
                annyang.addCallback('result', function(phrases) {
                    capturedText += phrases[0] + " "; // Append the recognized phrases to the captured text
                    clearTimeout(silenceTimer); // Reset the timer on new speech detected
                    silenceTimer = setTimeout(processCapturedText, 2000); // Set a new timer
                });
        
                // Initialize SpeechKITT for a nicer UI
                SpeechKITT.annyang();
                SpeechKITT.setStylesheet('https://cdnjs.cloudflare.com/ajax/libs/SpeechKITT/0.3.0/themes/flat.css');
                SpeechKITT.displayRecognizedSentence(true);
                SpeechKITT.start();
                annyang.addCallback('end', function() {
                    if (capturedText !== "") {
                        processCapturedText(); // Process any remaining text when the recognizer stops
                    }
                    console.log("Speech recognition ended. Restarting...");
                    annyang.stop(); // Optionally restart recognition if it stops
                });
                
                // Start annyang with continuous listening
                annyang.start({ continuous: true });
            }
        }
        



    </script>
</body>

</html>