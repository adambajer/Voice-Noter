<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Voice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <script src="annyang.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
   
    <style>
        body {
            padding-top: 20px;
        }
        #notesContainer {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
        }
        .note {
            background-color: #e9ecef;
            margin-top: 5px;
            padding: 8px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="p-3">
    <h1>Voice Noter</h1>
    <ul id="notebookTabs" class="nav nav-tabs"></ul>
    <button id="createNotebookButton" class="btn btn-primary mt-3">Create New Notebook</button>
    <div class="input-group mt-3">
        <input type="text" id="noteInput" class="form-control" placeholder="Enter a note">
        <button id="addNoteButton" class="btn btn-secondary">Add Note</button>
    </div>
    <button id="startVoiceNoteButton" class="btn btn-info mt-3">Start Voice Note</button>
    <div id="notesContainer" class="p-3"></div>
    <script>

        const firebaseConfig = {
            databaseURL: "https://voice-noter-default-rtdb.europe-west1.firebasedatabase.app",
        };

        firebase.initializeApp(firebaseConfig);
        let userId = sessionStorage.getItem('userId') || generateUserId();

        function generateUserId() {
            const newId = Date.now().toString(36) + Math.random().toString(36).substr(2);
            sessionStorage.setItem('userId', newId);
            return newId;
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('createNotebookButton').addEventListener('click', createNotebook);
            document.getElementById('addNoteButton').addEventListener('click', addNoteFromInput);
            document.getElementById('startVoiceNoteButton').addEventListener('click', startVoiceNote);
            loadUserNotebooks();
        });

        function addNoteFromInput() {
            const noteContent = document.getElementById('noteInput').value;
            const notebookId = document.querySelector('.active')?.dataset.notebookId;
            if (noteContent && notebookId) {
                addNote(noteContent, notebookId);
            }
        }

        function loadUserNotebooks() {
            const userNotebooksRef = firebase.database().ref(`users/${userId}/notebooks`);
            userNotebooksRef.on('value', function(snapshot) {
                const notebooks = snapshot.val() || {};
                document.getElementById('notebookTabs').innerHTML = '';
                Object.keys(notebooks).forEach(notebookId => {
                    createTab(notebookId);
                });
                if (Object.keys(notebooks).length === 0) {
                    createNotebook();
                }
            });
        }

        function createNotebook() {
            const newNotebookRef = firebase.database().ref(`users/${userId}/notebooks`).push();
            newNotebookRef.set({ createdAt: Date.now() }, function(error) {
                if (!error) {
                    createTab(newNotebookRef.key, true);
                }
            });
        }

        function createTab(notebookId, setActive = false) {
            var tab = document.createElement('li');
            tab.className = 'nav-item';
            var link = document.createElement('a');
            link.className = 'nav-link';
            link.href = '#';
            link.textContent = `Notebook ${notebookId}`;
            link.dataset.notebookId = notebookId;
            link.onclick = function() {
                document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                loadNotes(notebookId);
                return false;
            };
            tab.appendChild(link);
            document.getElementById('notebookTabs').appendChild(tab);
            if (setActive) {
                link.click();
            }
        }

        function loadNotes(notebookId) {
            var notebookNotesRef = firebase.database().ref(`users/${userId}/notebooks/${notebookId}/notes`);
            notebookNotesRef.on('value', function(snapshot) {
                const notes = snapshot.val() || {};
                document.getElementById('notesContainer').innerHTML = '';
                Object.keys(notes).forEach(noteId => {
                    var noteElement = document.createElement('div');
                    noteElement.className = 'note';
                    noteElement.textContent = notes[noteId].content;
                    document.getElementById('notesContainer').appendChild(noteElement);
                });
            });
        }

        function addNote(content, notebookId) {
            var newNoteRef = firebase.database().ref(`users/${userId}/notebooks/${notebookId}/notes`).push();
            newNoteRef.set({ content: content, createdAt: Date.now() });
        }

        function startVoiceNote() {
            if (annyang) {
                console.log("Je tady");
                annyang.addCommands({
                    'save note *note': function(note) {
                        const notebookId = document.querySelector('.active')?.dataset.notebookId;
                        if (notebookId) {
                            addNote(note, notebookId);
                        } else {
                            console.log('No active notebook selected.');
                        }
                    }
                });
                annyang.start();
            }
        }
    </script> 
</body>
</html>
