<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>NOTES</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.1/annyang.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/SpeechKITT/1.0.0/themes/flat.css" rel="stylesheet">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <script src="annyang.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SpeechKITT/1.0.0/speechkitt.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body {
            background: #fdfde8;
         }

        #notesContainer2 {

            border-radius: 0.5vw;
         }


        #notebookTabs {}

     

        #noteInput {
            background: transparent;
            border: 0px;
            position: relative;
            border-top-right-radius: 5px;
            flex-wrap: wrap;
            display: flex;
            border-bottom: 0.001vh solid #ccc;
            border-bottom-right-radius: 0px;
            margin-bottom: 0.4vh;
            color: hsl(235, 100%, 18%);
            border-radius: 0px;
            padding: 10px;
            margin: 0px;
        }

        .cus {
            width: 100%;  
            background-color: white;
         }

        @keyframes pulsate {

            0%,
            100% {
                box-shadow: 0 0 0 5px rgba(227, 55, 55, 0), 0 0 0 5px rgb(227, 55, 55);
            }

            50% {
                box-shadow: 0 0 0 20px rgba(227, 55, 55, 0.7);
                backdrop-filter: blur(5px);
            }
        }

        #skitt-ui.skitt-ui--listening {

            background-color: rgb(255, 75, 75) !important;
        }

        #skitt-ui.skitt-ui--listening #skitt-toggle-button {

            background-color: red !important;
            animation: pulsate 2s infinite;
        }



        .note {
            position: relative;
            flex-wrap: wrap;
            display: flex;
            color: #00085c;
            padding: 10px;
            border-radius: 0px;
            border-bottom: 1px solid #ccc;
            /* Ensure there's padding for text visibility */
        }

        /* Optionally style the title attribute tooltip */
        /* Optionally style the title attribute tooltip */
        .note:hover:after {
            content: attr(data-title); /* Use data-title for the tooltip text */
            position: absolute;
            left: 0;
            top: 100%;
            white-space: wrap;
            z-index: 20;
            background-color: #f5f5f5;
            padding: 4px 8px;
            max-width: 180px; /* Maximum width with text wrapping */
            padding: 8px 10px; /* Padding around text */
            color: #333; /* Text color */
            background-color: #fff; /* Background color */
            border-radius: 4px; /* Rounded corners */
            box-shadow: 0 4px 8px rgba(0,0,0,0.25); /* Shadow for depth */
            font-size: 0.75rem;
        }

       
        .shareicon {
            width: 0px;
            height: 18px;
            /* position: absolute; */
            /* background: #fefee9; */
            /* border: 1px solid #ccc; */
            cursor: pointer;
            /* border-radius: 2px; */
            opacity: 0;
            margin-left: 5PX;

        }

        .shareicon PATH {
            fill: WHITE;
        }

        .nav-link:hover .shareicon {
            width: 18px;

            opacity: 1;
        }

        #bar .app-title {
            font-size: 24px;
            /* Set the font size as desired */
            color: #5bbad5;
            /* Theme color */
            margin-right: auto;
            /* Pushes other elements to the right */
            padding-left: 10px;
            /* Optional: Adds some padding on the left */
        }
        .navbar {
            display: flex;
            align-items: center; /* Center items vertically */
            justify-content: space-between; /* Space out navbar items */
        }
        
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 10px; /* Space between the logo and text */
        }
        
        .navbar-toggler {
            margin-right: 10px; /* Add space between hamburger menu and logo if needed */
        }
        .dropdownBtn   {
            display: inline-block;
          background-color: transparent;border-right:1px solid #ccc;
           padding: 0.5rem;
           padding-left: 0px;
          border-radius: 0px;
          margin-left: 0.5rem;
        }
        
        .nav-link:hover .dropdownBtn,.nav-link:active .dropdownBtn,.nav-link:focus .dropdownBtn,.nav-link:target .dropdownBtn,.nav-link.active .dropdownBtn   {
            display: inline-block;
        }
        
        
.nav-link button.dropdownBtn { }
.nav-pills .nav-link.active, .nav-pills .show>.nav-link {
background-color: #ccc;}
.custom-tooltip {
    display: none; /* Hidden by default */
    position: absolute;
    z-index: 10;
    width: 30%;
    background-color: #f9f9f9;
    border: 1px solid #d3d3d3;
    border-radius: 5px;
    padding: 10px;
    color: #000; 
    text-align: left;
    font-size: 0.9em;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
}
#userIcon {
cursor: pointer;
border-top-right-radius: 5px;
border-top-left-radius: 5px;
background-color: black;
padding: 5px;
}
#userIcon:hover  {
background-color: red;}
/* Positioning the tooltip text */
#userIcon:hover + .custom-tooltip {
    display: block; /* Show the tooltip on hover */
    top: 50px; /* Adjust this value based on your layout */
    right: 0.75rem;  /* Adjust this value based on your layout */
}
.dropdown-item-delete {
    color: red; /* Set the color to red for delete action */
}

/* Optional: Change the hover color to a darker shade of red */
.dropdown-item-delete:hover {
    color: darkred;
}
#notebookTabs .nav-item {
    display: inline-flex;
    justify-content: space-between;
    align-items: center;
    border-right: 1px solid #ccc;
    padding: 0px !important;
}
#notebookTabs .nav-item .btn {
border-radius: 0px;}

#notebookTabs .nav-link {
color:black !important;
padding:6px;
border-radius: 0px !important;
height: 100%;
}
.note.finished {
    text-decoration: line-through;
    color: #aaa; /* Gray out the text to show it's completed */
}

.note-checkbox {
    margin-right: 10px; /* Adjust the margin size as needed */
}
.delete-note {
    position: absolute;
    right: 20px;
    font-size: 0.75rem;
    padding: 2px 5px;
    margin-left: 10px;
    background-color: #f44336;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    visibility: hidden;
 }

.note:hover .delete-note {
    visibility: visible;
    background-color: #d32f2f;
}

    </style>
</head>

<body class="">
  
    <div class="main-content" id="main-content">
      
        <div id="bar" class=" ">
            
            <nav class="navbar bg-dark navbar-expand-lg bg-body-tertiary" data-bs-theme="dark">
                <div class="container-fluid">
                    <!-- Hamburger Menu first -->
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo03" aria-controls="navbarTogglerDemo03" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="menu-icon">☰</span> <!-- Hamburger Icon -->
                    </button>
            
                    <!-- Logo and Brand Name next to the hamburger -->
                    <a class="navbar-brand" href="#">
                        <img src="favicon.svg" width="30px" height="30px" class="pe-2">
                        <span>NOTES</span>
                    </a>
            
                    <!-- Rest of the navbar items -->
                    <div class="collapse navbar-collapse" id="navbarTogglerDemo03">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item dropdown">
                                <button class="btn btn-dark menu-icon" data-bs-toggle="dropdown" aria-expanded="false">
                                    ☰ <!-- If you need a second menu, otherwise remove this -->
                                </button>
                                <ul class="dropdown-menu dropdown-menu-dark">
                                    <li><a class="dropdown-item" href="#">Export</a></li>
                                    <li><a class="dropdown-item" href="#">Share app</a></li>
                                    <li><a class="dropdown-item" href="#">About</a></li>
                                </ul>
                            </li>
                        </ul>
                        
                        <img id="userIcon" src="user-icon.svg" alt="User Icon" class="user-icon" style="width: 43px; height: 43px;">
                        <div id="userTooltip" class="custom-tooltip">

                    </div>
                </div>
            </nav>
            
             
        </div>
        
    <div class="d-flex cus align-items-center border-bottom">


        <!-- Title of the app added here -->
        <ul id="notebookTabs" class="nav nav-pills">
        </ul>
        <button id="createNotebookButton" class="btn btn-outline-danger  rounded-0" title="Nový blok poznámek">Nový blok</button>

    </div>
    <div id="notesContainer2" class="">
        <div class="d-inline-flex w-100 justify-content-end">
            <input type="text" id="noteInput" class="form-control" placeholder="Text poznámky napiš zde ...">
          
        </div>
        <div id="notesContainer" class=""></div>

 
    </div>
      
</div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let urlParams = new URLSearchParams(window.location.search);
            let notebookId = urlParams.get('notebook');  // Get 'notebook' parameter from URL
            let userId = localStorage.getItem('userId') || generateUserId(); // Fetch from localStorage
            localStorage.setItem('userId', userId); // Store in localStorage if not already present
            let deviceInfo = getDeviceInfo();

            const userIcon = document.getElementById('userIcon');
            const userTooltip = document.getElementById('userTooltip');
            userTooltip.innerHTML = `
                <strong>UID:</strong> ${userId}<br>
                <strong>Platform:</strong> ${deviceInfo.platform}<br>
                <strong>User Agent:</strong> ${deviceInfo.userAgent}<br>
                <strong>Language:</strong> ${deviceInfo.language}<br>
                <strong>Resolution:</strong> ${deviceInfo.resolution}<br>
                <strong>Color Depth:</strong> ${deviceInfo.colorDepth}<br>
                <strong>Timezone Offset:</strong> ${deviceInfo.timezoneOffset}`;
            if (notebookId) {
                // If notebookId is found, set it active and load its notes only



                loadNotes(notebookId);

                const noteInput = document.getElementById('noteInput');
                noteInput.addEventListener('keydown', function(event) {
                    if (event.key === "Enter") {
                        addNoteFromInput();  // Function to handle note addition
                        event.preventDefault();  // Prevent default Enter key behavior (form submission)
                    }
                });
            
                noteInput.addEventListener('blur', addNoteFromInput); 
                document.getElementById('createNotebookButton').addEventListener('click', createNotebook);
            } else {
                // If no specific notebookId, load all user notebooks
                loadUserNotebooks(function() {
                    let activeNotebookId = localStorage.getItem('activeNotebookId');
                    if (activeNotebookId) {
                        setActiveTab(activeNotebookId);
                    }
                });
                const noteInput = document.getElementById('noteInput');
                noteInput.addEventListener('keydown', function(event) {
                    if (event.key === "Enter") {
                        addNoteFromInput();  // Function to handle note addition
                        event.preventDefault();  // Prevent default Enter key behavior (form submission)
                    }
                });
            
                noteInput.addEventListener('blur', addNoteFromInput); 
                document.getElementById('createNotebookButton').addEventListener('click', createNotebook);
            }
            toggleSpeechKITT();
        });
        
        function saveActiveTabUID(uid) {
            localStorage.setItem('activeTabUID', uid);
        }
        function setActiveTab(notebookId) {
            const notebookTabs = document.querySelectorAll('.nav-link');
            notebookTabs.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.notebookId === notebookId) {
                    link.classList.add('active');
                    localStorage.setItem('activeNotebookId', notebookId); // Save the active notebook ID
                }
            });
        
            loadNotes(notebookId); // Load notes for the active notebook
        }
        

        function saveActiveTabUID(uid) {
            localStorage.setItem('activeTabUID', uid);
        }



        // Function to retrieve the active tab's UID from local storage
        function getActiveTabUID() {
            return localStorage.getItem('activeTabUID');
        }
        const firebaseConfig = {
            databaseURL: "https://voice-noter-default-rtdb.europe-west1.firebasedatabase.app",
        };

        firebase.initializeApp(firebaseConfig);
        let userId = sessionStorage.getItem('userId') || generateUserId();

        function generateUserId() {
            function getDeviceFingerprint() {
                var navigatorData = window.navigator;
                var screenData = window.screen;
                var fingerprint = [
                    navigatorData.platform,
                    navigatorData.userAgent.replace(/\d+/g, ""), // Remove digits to minimize version changes
                    navigatorData.language,
                    screenData.height,
                    screenData.width,
                    screenData.colorDepth,
                    new Date().getTimezoneOffset()
                ].join('|');
                return fingerprint;
            }

            function hashString(str) {
                // Simple hash function for illustration
                var hash = 0, i, chr;
                for (i = 0; i < str.length; i++) {
                    chr = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + chr;
                    hash |= 0; // Convert to 32bit integer
                }
                return hash;
            }

            const fingerprint = getDeviceFingerprint();
            const hashedFingerprint = hashString(fingerprint).toString(16); // Convert to hex
            const shortId = hashedFingerprint.substr(0, 8); // Take first 8 characters

            const storedUserId = localStorage.getItem('userId');
            if (storedUserId === shortId) {
                return storedUserId;
            } else {
                localStorage.setItem('userId', shortId);
                return shortId;
            }
        }
        function getDeviceInfo() {
            var navigatorData = window.navigator;
            var screenData = window.screen;
            var deviceInfo = {
                platform: navigatorData.platform,
                userAgent: navigatorData.userAgent.replace(/\d+/g, ""), // Remove digits to minimize version changes
                language: navigatorData.language,
                resolution: `${screenData.width} x ${screenData.height}`,
                colorDepth: `${screenData.colorDepth}-bit`,
                timezoneOffset: `UTC ${new Date().getTimezoneOffset() / 60}`
            };
            return deviceInfo;
        }
     
        function getNotebookIdFromPath() {
            // Example URL: "https://adambajer.github.io/Voice-Noter/notebooks/-NxLpMKvPUyhOnM50UvE"
            // Splitting by '/' gives us: ["https:", "", "adambajer.github.io", "Voice-Noter", "notebooks", "-NxLpMKvPUyhOnM50UvE"]
            const pathSegments = window.location.pathname.split('/');
            // Notebook ID is expected to be after 'notebooks', adjust the index accordingly.
            const notebookIndex = pathSegments.indexOf('notebooks');
            if (notebookIndex !== -1 && notebookIndex + 1 < pathSegments.length) {
                return pathSegments[notebookIndex + 1];
            }
            return null; // Return null if no notebook ID is found
        }
        function generateCustomNotebookId() {
            // Generates a random 16-character alphanumeric string
            return [...Array(16)].map(() => Math.floor(Math.random() * 36).toString(36)).join('');
        }


        function addNoteFromInput() {
            const noteContent = document.getElementById('noteInput').value;
            const notebookId = document.querySelector('.nav-link.active')?.dataset.notebookId;
            if (noteContent && notebookId) {
                addNote(noteContent, notebookId);
                document.getElementById('noteInput').value = ''; // Clear the input after adding a note
            }
        }
        function loadUserNotebooks(callback) {
            const userNotebooksRef = firebase.database().ref(`users/${userId}/notebooks`);
            userNotebooksRef.once('value', snapshot => {
                const notebooks = snapshot.val();
                if (notebooks) {
                    Object.keys(notebooks).forEach((notebookId, index) => {
                        const notebookData = notebooks[notebookId];
                        const notebookName = notebookData.name || "";
                        const noteCount = notebookData.notes ? Object.keys(notebookData.notes).length : 0;
                        createTab(notebookId, index === 0, noteCount, notebookName);
                    });
                } else {
                    console.log("No notebooks found, creating one...");
                    createNotebook();
                }
                if (callback) callback();
            }, error => {
                console.error("Failed to fetch notebooks:", error);
            });
        }
        
        

        function createNotebook() {
            const userId = sessionStorage.getItem('userId');  // Ensure you have the userId stored in session
            const newNotebookId = generateCustomNotebookId(); // Use the custom ID generator
            const newNotebookRef = firebase.database().ref(`notebooks/${newNotebookId}`);
            newNotebookRef.set({
                userId: userId,  // Store the userId as part of the notebook data
                createdAt: Date.now()
            }, error => {
                if (!error) {
                    createTab(newNotebookId, true); // Set this new notebook as active
                } else {
                    console.error('Error creating notebook:', error);
                }
            });
        }function createTab(notebookId, setActive = false, noteCount = 0, notebookName = "") {
            var tab = document.createElement('li');
            tab.className = 'nav-item d-inline-flex justify-content-between'; // Add flexbox layout here
        
            // Create the link that will act as the main clickable area for the tab
            var link = document.createElement('a');
            link.className = 'nav-link'; // Ensure it grows to take available space
            link.href = '#';
            link.dataset.notebookId = notebookId;
        
            // Notebook icon
            var img = document.createElement('img');
            img.src = "note.svg";
            img.alt = "Note Icon";
            img.style.width = "24px";
            img.style.height = "24px";
        
            // Span for displaying the notebook name
            var nameLabel = document.createElement('span');
            nameLabel.className = 'notebook-name ms-2';
            nameLabel.textContent = notebookName;
        
            // Badge for displaying the note count
            var badge = document.createElement('span');
            badge.className = 'badge bg-danger ms-2';
            badge.textContent = noteCount;
        
            // Append elements to the link
            link.appendChild(img);
            link.appendChild(nameLabel);
            link.appendChild(badge);
        
            // Dropdown button for additional options
            var dropdownBtn = document.createElement('button');
            dropdownBtn.className = 'btn';
            dropdownBtn.setAttribute('data-bs-toggle', 'dropdown');
            dropdownBtn.ariaExpanded = false;
            dropdownBtn.innerHTML = '⋮';
        
            // Dropdown menu containing various actions
            var dropdownMenu = document.createElement('div');
            dropdownMenu.className = 'dropdown-menu';
            dropdownMenu.appendChild(createDropdownItem('Rename', () => promptRenameNotebook(notebookId, nameLabel)));
            dropdownMenu.appendChild(createDropdownItem('Share', () => shareNotebook(notebookId)));
            dropdownMenu.appendChild(createDropdownItem('Duplicate', () => copyNotebook(notebookId)));
            dropdownMenu.appendChild(createDropdownItem('Download as TXT', () => downloadNotebookAsText(notebookId)));
            dropdownMenu.appendChild(createDropdownItem('Delete', () => deleteNotebook(notebookId)));
        
            // Append the link and dropdown button to the tab
            tab.appendChild(link);
            tab.appendChild(dropdownBtn);
            tab.appendChild(dropdownMenu);
        
            // Set up the tab's behavior on click
            link.onclick = function (event) {
                event.preventDefault(); // Prevent default link behavior
                document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                loadNotes(notebookId);
                saveActiveTabUID(notebookId);
            };
        
            // Append the tab to the document
            document.getElementById('notebookTabs').appendChild(tab);
        
            // Automatically make the new tab active if required
            if (setActive) {
                link.click();
            }
        
            // Return the elements that may need dynamic updates
            return { badge: badge, nameLabel: nameLabel };
        }
        
        
 
        
        function promptRenameNotebook(notebookId, nameLabel) {
            const currentName = nameLabel.textContent;
            const newName = prompt("Please enter a new name for the notebook:", currentName);
            if (newName && newName.trim() !== "" && newName !== currentName) {
                renameNotebook(notebookId, newName.trim(), nameLabel);
            }
        }
        
        function renameNotebook(notebookId, newName, nameLabel) {
            const notebookRef = firebase.database().ref(`users/${userId}/notebooks/${notebookId}`);
            notebookRef.update({ name: newName }).then(() => {
                nameLabel.textContent = newName; // Update the notebook name in the UI
                console.log("Notebook renamed successfully");
            }).catch(error => {
                console.error("Error renaming notebook:", error);
            });
        }
        
       

function createDropdownItem(text, action) {
    var item = document.createElement('a');
    item.className = 'dropdown-item';
    item.href = '#';
    item.textContent = text;

    // Assign additional class based on the action text
    if (text.toLowerCase() === 'delete') {
        item.classList.add('dropdown-item-delete');
    }

    item.onclick = function (event) {
        event.preventDefault(); // Prevent the link from triggering a page reload
        action();
    };
    return item;
}

        function shareNotebook(notebookId) {
            const shareUrl = `/notebook/${notebookId}`;
            console.log("Sharing notebook:", notebookId);
            // Implement actual sharing logic, e.g., copy to clipboard
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('Share link copied to clipboard: ' + shareUrl);
            }, (err) => {
                console.error('Error copying link to clipboard', err);
            });
        }
        
        
        function deleteNotebook(notebookId) {
            const notebookRef = firebase.database().ref(`users/${userId}/notebooks/${notebookId}`);
            notebookRef.remove()
            .then(() => {
                alert('Notebook successfully deleted.');
                // Remove the tab from the UI
                removeTab(notebookId);
            })
            .catch(error => {
                console.error('Error deleting notebook:', error);
                alert('Failed to delete notebook: ' + error);
            });
        }
        
        function removeTab(notebookId) {
            const tabElement = document.querySelector(`a[data-notebook-id="${notebookId}"]`).parentNode;
            if (tabElement) {
                tabElement.parentNode.removeChild(tabElement);
            }
        }
        
        
        function copyNotebook(notebookId) {
            const notebookRef = firebase.database().ref(`users/${userId}/notebooks/${notebookId}`);
            notebookRef.once('value', snapshot => {
                const data = snapshot.val();
                const newNotebookId = generateCustomNotebookId(); // Assuming you have a function to generate IDs
                const newNotebookRef = firebase.database().ref(`users/${userId}/notebooks/${newNotebookId}`);
                newNotebookRef.set(data)
                .then(() => {
                    alert('Notebook copied successfully, new notebook ID: ' + newNotebookId);
                    createTab(newNotebookId, true); // Adding new notebook tab to UI
                })
                .catch(error => {
                    alert('Failed to copy notebook: ' + error);
                });
            });
        }
        
        function downloadNotebookAsText(notebookId) {
            const notesRef = firebase.database().ref(`users/${userId}/notebooks/${notebookId}/notes`);
            notesRef.once('value', snapshot => {
                const notes = snapshot.val();
                const allNotesText = Object.keys(notes).map(key => notes[key].content).join('\n');
                const element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(allNotesText));
                element.setAttribute('download', `notebook-${notebookId}.txt`);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
             })
            .catch(err => {
                alert('Error downloading the notebook: ' + err);
            });
        }
        function loadNotes(notebookId) {
            var notebookNotesRef = firebase.database().ref(`users/${userId}/notebooks/${notebookId}/notes`);
            notebookNotesRef.on('value', function (snapshot) {
                const notes = snapshot.val() || {};
                document.getElementById('notesContainer').innerHTML = '';
                Object.keys(notes).forEach(noteId => {
                    var noteElement = document.createElement('div');
                    noteElement.className = 'note';
                    noteElement.contentEditable = !notes[noteId].finished;
                    noteElement.textContent = notes[noteId].content;
                    noteElement.setAttribute('data-note-id', noteId);
        
                     // Format the creation and update dates
            let createdAt = formatDate(new Date(notes[noteId].createdAt));
            let updatedAt = formatDate(new Date(notes[noteId].updatedAt));
            
            // Set the tooltip content based on whether createdAt and updatedAt are the same
            let tooltipContent = `Vytvořeno: ${createdAt}`;
            if (createdAt !== updatedAt) {
                tooltipContent += `, Upraveno: ${updatedAt}`;
            }
            
            noteElement.setAttribute('data-title', tooltipContent);

                    var checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'note-checkbox';
                    checkbox.checked = notes[noteId].finished || false;
                    checkbox.onchange = function () {
                        toggleNoteFinished(notebookId, noteId, checkbox.checked);
                        noteElement.contentEditable = !checkbox.checked;
                    };
        
                    var deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Smazat';
                    deleteBtn.className = 'delete-note';
                    deleteBtn.onclick = function () {
                        deleteNote(notebookId, noteId);
                    };
        
                    if (notes[noteId].finished) {
                        noteElement.classList.add('finished');
                    }
        
                    noteElement.prepend(checkbox);
                    noteElement.appendChild(deleteBtn);
        
                    document.getElementById('notesContainer').prepend(noteElement);
                });
            });
        }
        function deleteNote(notebookId, noteId) {
            var noteRef = firebase.database().ref(`users/${userId}/notebooks/${notebookId}/notes/${noteId}`);
            noteRef.remove()
                .then(() => {
                    console.log('Note deleted successfully');
                    var noteElement = document.querySelector(`div[data-note-id="${noteId}"]`);
                    if (noteElement) {
                        noteElement.parentNode.removeChild(noteElement);
                    }
                })
                .catch(error => {
                    console.error('Failed to delete note:', error);
                });
        }
        
        
        function toggleNoteFinished(notebookId, noteId, isFinished) {
            var noteRef = firebase.database().ref(`users/${userId}/notebooks/${notebookId}/notes/${noteId}`);
            noteRef.update({
                finished: isFinished
            }, error => {
                if (error) {
                    console.error('Failed to update note:', error);
                } else {
                    console.log('Note updated successfully');
                    var noteElement = document.querySelector(`div[data-note-id="${noteId}"]`); // Ensure you set `data-note-id` attribute when creating the note element
                    if (isFinished) {
                        noteElement.classList.add('finished');
                        noteElement.contentEditable = false;  // Disable editing when finished
                    } else {
                        noteElement.classList.remove('finished');
                        noteElement.contentEditable = true;  // Enable editing when not finished
                    }
                }
            });
        }
        
        
        function addNote(content, notebookId) {
            var now = new Date();
            var newNoteRef = firebase.database().ref(`users/${userId}/notebooks/${notebookId}/notes`).push();
            newNoteRef.set({
                content: content,
                createdAt: now.getTime(),
                updatedAt: now.getTime()  // Initially, creation and update time are the same
            }, error => {
                if (error) {
                    console.error('Failed to add note:', error);
                } else {
                    console.log('Note added successfully');
                    updateNoteCount(notebookId, 1);  // Increment the note count for the notebook

                }
            });
        }
        function updateNoteCount(notebookId, increment) {
            const badge = document.querySelector(`a[data-notebook-id="${notebookId}"] .badge`);
            let count = parseInt(badge.textContent) || 0;
            badge.textContent = count + increment;
        }
        
        function formatDate(date) {
            let day = date.getDate();
            let month = date.getMonth() + 1; // Months start at 0!
            let year = date.getFullYear();
            let hours = date.getHours();
            let minutes = date.getMinutes();
            return `${day}.${month}.${year} ${hours}:${minutes}`;
        }

        function updateNote(notebookId, noteId, content) {
            var now = new Date();
            var noteRef = firebase.database().ref(`users/${userId}/notebooks/${notebookId}/notes/${noteId}`);
            noteRef.update({
                content: content,
                updatedAt: now.getTime()  // Update the timestamp when the note is edited
            }, error => {
                if (error) {
                    console.error('Failed to update note:', error);
                } else {
                    console.log('Note updated successfully');
                }
            });
        }
        
        
        function toggleSpeechKITT() {
            if (typeof annyang === 'undefined' || typeof SpeechKITT === 'undefined') {
                console.error("Annyang or SpeechKITT is not loaded!");
                return;
            }
        
            // Initialize SpeechKITT settings once
            SpeechKITT.annyang();
            annyang.setLanguage('cs'); // Set the desired language

            SpeechKITT.setStylesheet('https://cdnjs.cloudflare.com/ajax/libs/SpeechKITT/1.0.0/themes/flat.css');
            SpeechKITT.setInstructionsText('Press the microphone button to start speaking');
            SpeechKITT.displayRecognizedSentence(true);
        
            // Toggle SpeechKITT and annyang
            if (!SpeechKITT.isListening()) {
                SpeechKITT.setStartCommand(() => annyang.start({ continuous: true }));
                SpeechKITT.setAbortCommand(() => annyang.abort());
                SpeechKITT.vroom();
            } else {
                if (annyang.isListening()) {
                    SpeechKITT.abortRecognition();
                    document.getElementById('voiceButton').textContent = "Start Voice Recognition";
                } else {
                    SpeechKITT.startRecognition();
                    document.getElementById('voiceButton').textContent = "Stop Voice Recognition";
                }
            }
        
            // Handle voice recognition result
            annyang.addCallback('result', function(phrases) {
                // Assume the first phrase is the most accurate
                let text = phrases[0];
                const notebookId = document.querySelector('.nav-link.active')?.dataset.notebookId;
                if (notebookId && text.trim() !== "") {
                    addNote(text, notebookId);
                    console.log("Added note: ", text);
                    SpeechKITT.abortRecognition();
                    document.getElementById('voiceButton').textContent = "Start Voice Recognition";
                }
            });
        }
        
         
        
        


    </script>
</body>

</html>