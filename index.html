<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Voice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <script src="annyang.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
   
    <style>
        body {
            padding-top: 20px;
        }
        #notesContainer {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
        }
        .note {
            background-color: #e9ecef;
            margin-top: 5px;
            padding: 8px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="p-3">
    <h1>Voice Noter</h1>
    <ul id="notebookTabs" class="nav nav-tabs"></ul>
    <button id="createNotebookButton" class="btn btn-primary mt-3">Create New Notebook</button>
    <div class="input-group mt-3">
        <input type="text" id="noteInput" class="form-control" placeholder="Enter a note">
        <button id="addNoteButton" class="btn btn-secondary">Add Note</button>
    </div>
    <button id="startVoiceNoteButton" class="btn btn-info mt-3">Start Voice Note</button>
    <div id="notesContainer" class="p-3"></div>
    <script>
        function saveActiveTabUID(uid) {
            localStorage.setItem('activeTabUID', uid);
        }
        function setActiveTab(notebookId) {
            const notebookTabs = document.querySelectorAll('.nav-link');
            notebookTabs.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.notebookId === notebookId) {
                    link.classList.add('active');
                }
            });
        
            if (notebookId) {
                loadNotes(notebookId);
                saveActiveTabUID(notebookId); // Ensure this is called whenever the active tab is set
            }
        }
      
        
        // Function to retrieve the active tab's UID from local storage
        function getActiveTabUID() {
            return localStorage.getItem('activeTabUID');
        }
        const firebaseConfig = {
            databaseURL: "https://voice-noter-default-rtdb.europe-west1.firebasedatabase.app",
        };

        firebase.initializeApp(firebaseConfig);
        let userId = sessionStorage.getItem('userId') || generateUserId();

        function generateUserId() {
            const newId = Date.now().toString(36) + Math.random().toString(36).substr(2);
            sessionStorage.setItem('userId', newId);
            return newId;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            loadUserNotebooks();
        });
        

        function addNoteFromInput() {
            const noteContent = document.getElementById('noteInput').value;
            const notebookId = document.querySelector('.nav-link.active')?.dataset.notebookId;
            if (noteContent && notebookId) {
                addNote(noteContent, notebookId);
                document.getElementById('noteInput').value = ''; // Clear the input after adding a note
            }
        }
        function loadUserNotebooks() {
            const userNotebooksRef = firebase.database().ref(`users/${userId}/notebooks`);
            userNotebooksRef.once('value', snapshot => {
                const notebooks = snapshot.val();
                console.log("Notebooks fetched: ", notebooks); // Debug output
        
                if (notebooks && Object.keys(notebooks).length > 0) {
                    Object.keys(notebooks).forEach((notebookId, index) => {
                        createTab(notebookId, index === 0); // Set the first tab as active by default
                    });
        
                    const activeTabUID = getActiveTabUID();
                    if (activeTabUID) {
                        setActiveTab(activeTabUID);
                    } else {
                        setActiveTab(Object.keys(notebooks)[0]);
                    }
                } else {
                    console.log("No notebooks found, creating one..."); // Debug output
                    createNotebook(); // Only create a new notebook if none are found
                }
            }, error => {
                console.error("Failed to fetch notebooks:", error); // Error handling
            });
        }

        function createNotebook() {
            const newNotebookRef = firebase.database().ref(`users/${userId}/notebooks`).push();
            newNotebookRef.set({ createdAt: Date.now() }, function(error) {
                if (!error) {
                    createTab(newNotebookRef.key, true); // Also set this new notebook as active
                }
            });
        }
       

function createTab(notebookId, setActive = false) {
    var tab = document.createElement('li');
    tab.className = 'nav-item';
    var link = document.createElement('a');
    link.className = 'nav-link';
    link.href = '#';
    link.textContent = `Notebook ${notebookId}`;
    link.dataset.notebookId = notebookId;
    link.onclick = function() {
        document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        loadNotes(notebookId);
        saveActiveTabUID(notebookId); // Save the active tab UID whenever a tab is clicked
        return false;
    };
    tab.appendChild(link);
    document.getElementById('notebookTabs').appendChild(tab);
    if (setActive) {
        link.click(); // Automatically click the link to set it as active if specified
    }
}
        function loadNotes(notebookId) {
            var notebookNotesRef = firebase.database().ref(`users/${userId}/notebooks/${notebookId}/notes`);
            notebookNotesRef.on('value', function(snapshot) {
                const notes = snapshot.val() || {};
                document.getElementById('notesContainer').innerHTML = '';
                Object.keys(notes).forEach(noteId => {
                    var noteElement = document.createElement('div');
                    noteElement.className = 'note';
                    noteElement.textContent = notes[noteId].content;
                    document.getElementById('notesContainer').appendChild(noteElement);
                });
            });
        }

        function addNote(content, notebookId) {
            console.log(`Attempting to add note to notebook ${notebookId}: ${content}`); // Debug output
            var newNoteRef = firebase.database().ref(`users/${userId}/notebooks/${notebookId}/notes`).push();
            newNoteRef.set({ content: content, createdAt: Date.now() }, error => {
                if (error) {
                    console.error('Failed to add note:', error);
                } else {
                    console.log('Note added successfully');
                }
            });
        }
        
        function startVoiceNote() {
            if (annyang) {
                annyang.setLanguage('cs');

                console.log("Annyang is ready to go!");
        
                let silenceTimer;
                let lastPhrase = '';
        
                // Function to handle saving the note
                function saveNoteIfAny() {
                    const notebookId = document.querySelector('.active')?.dataset.notebookId;
                    if (notebookId && lastPhrase) {
                        console.log('Adding note from voice:', lastPhrase);
                        addNote(lastPhrase, notebookId);
                        lastPhrase = ''; // Reset last phrase after saving
                    } else {
                        console.log('No active notebook selected or no note to save.');
                    }
                }
        
                // Setup to listen and capture any speech
                annyang.addCallback('result', function(phrases) {
                    clearTimeout(silenceTimer); // Clear previous timer
                    lastPhrase = phrases[0]; // Assume the first phrase is what the user said
                    console.log(`Heard: ${lastPhrase}`);
                    silenceTimer = setTimeout(saveNoteIfAny, 2000); // Set new timer
                });
        
                annyang.addCallback('resultNoMatch', function(phrases) {
                    clearTimeout(silenceTimer); // Clear previous timer
                    silenceTimer = setTimeout(saveNoteIfAny, 2000); // Reset timer after no match
                });
        
                annyang.addCallback('end', function() {
                    clearTimeout(silenceTimer); // Ensure no pending save operations
                    saveNoteIfAny(); // Save any last noted phrase when Annyang stops
                });
        
                // Start listening
                annyang.start({ continuous: false }); // Set to continuous if you want it to keep listening
            }
        }
        
        
        
    </script> 
</body>
</html>
