<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>VNOTER</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/SpeechKITT/0.3.0/themes/flat-emerald.css" rel="stylesheet">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <script src="annyang.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SpeechKITT/1.0.0/speechkitt.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body {
        background: #fdfde8;
        }

        #notesContainer2 {

            border-radius: 0.5vw; 
            background: #fdfde8;
        }

        .note {
            position: relative;
            border-top-right-radius: 5px;
            flex-wrap: wrap;
            display: flex;
            border-bottom: 0.001vh solid #9198e5;
            border-bottom-right-radius: 5px;
            margin-bottom: 0.4vh;
            color: #00085c;
        }

        #notebookTabs { 
        }

        #bar {
            display: inline-flex;
            flex-direction: row;
            align-content: center;
            flex-wrap: nowrap;
            align-items: center;
            width: -webkit-fill-available;
            justify-content: space-between;
            z-index: 999999;
            background: #ffffff;

            backdrop-filter: blur(7px);
            border: 1px solid #ccc;
        }

        #noteInput {
            background: transparent;
            border: 0px;
            position: relative;
            border-top-right-radius: 5px;
            flex-wrap: wrap;
            display: flex;
            border-bottom: 0.001vh solid #9198e5;
            border-bottom-right-radius: 0px;
            margin-bottom: 0.4vh;
            color: #00085c;
            border-radius: 0px;
            padding: 0px;
            margin: 0px;
        }
        #skitt-ui.skitt-ui--listening #skitt-toggle-button {
        background-color: background-color: #d00000 !important; 
    }
    #skitt-ui.skitt-ui--listening {
        background-color: red;
    }
    .cus {
        width: 100%;
        display: inline-flex !important;
         
        justify-content: space-between;
        flex-wrap: nowrap;
        align-items: center;
        width: 100%;
    }
    
    </style>
</head>

<body class="">
    <div id="bar" class="p-2">
        <div class="d-inline-flex cus input-group">
            <ul id="notebookTabs" class="nav nav-pills">
            </ul>
            <button id="createNotebookButton" class="btn btn-outline-danger ms-2">Nový</button>
        </div>

    </div>
    <div id="notesContainer2" class="p-2">
        <div class="input-group">
            <input type="text" id="noteInput" class="form-control" placeholder="Text poznámky napiš zde ...">
            <button id="addNoteButton" class="btn btn-outline-primary ms-2">Přidej</button>
        </div>
        <div id="notesContainer" class=""></div>
    </div>
    <script>
        function saveActiveTabUID(uid) {
            localStorage.setItem('activeTabUID', uid);
        }
        function setActiveTab(notebookId) {
            const notebookTabs = document.querySelectorAll('.nav-link');
            notebookTabs.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.notebookId === notebookId) {
                    link.classList.add('active');
                }
            });

            if (notebookId) {
                loadNotes(notebookId);
                saveActiveTabUID(notebookId); // Ensure this is called whenever the active tab is set
            }
        }


        // Function to retrieve the active tab's UID from local storage
        function getActiveTabUID() {
            return localStorage.getItem('activeTabUID');
        }
        const firebaseConfig = {
            databaseURL: "https://voice-noter-default-rtdb.europe-west1.firebasedatabase.app",
        };

        firebase.initializeApp(firebaseConfig);
        let userId = sessionStorage.getItem('userId') || generateUserId();

        function generateUserId() {
            function getDeviceFingerprint() {
                var navigatorData = window.navigator;
                var screenData = window.screen;
                var fingerprint = [
                    navigatorData.platform,
                    navigatorData.userAgent.replace(/\d+/g, ""), // Remove digits to prevent minor version changes affecting the ID
                    navigatorData.language,
                    screenData.height,
                    screenData.width,
                    screenData.colorDepth,
                    new Date().getTimezoneOffset()
                ].join('|');

                return btoa(fingerprint).replace(/=+$/, ''); // Encode to base64 and remove any trailing '='
            }

            const deviceFingerprint = getDeviceFingerprint();
            const storedUserId = localStorage.getItem('userId'); // Attempt to retrieve a stored user ID

            if (storedUserId && btoa(storedUserId).replace(/=+$/, '') === deviceFingerprint) {
                return storedUserId; // Return the stored ID if it matches the generated fingerprint
            } else {
                localStorage.setItem('userId', deviceFingerprint); // Store the new ID in localStorage
                return deviceFingerprint; // Return the new ID
            }
        }


        document.addEventListener('DOMContentLoaded', function () {
            loadUserNotebooks();
            document.getElementById('addNoteButton').addEventListener('click', addNoteFromInput);
            document.getElementById('createNotebookButton').addEventListener('click', createNotebook);
            setupVoiceRecognition();
        });


        function addNoteFromInput() {
            const noteContent = document.getElementById('noteInput').value;
            const notebookId = document.querySelector('.nav-link.active')?.dataset.notebookId;
            if (noteContent && notebookId) {
                addNote(noteContent, notebookId);
                document.getElementById('noteInput').value = ''; // Clear the input after adding a note
            }
        }
        function loadUserNotebooks() {
            const userNotebooksRef = firebase.database().ref(`users/${userId}/notebooks`);
            userNotebooksRef.once('value', snapshot => {
                const notebooks = snapshot.val();
                console.log("Notebooks fetched: ", notebooks); // Debug output

                if (notebooks && Object.keys(notebooks).length > 0) {
                    Object.keys(notebooks).forEach((notebookId, index) => {
                        createTab(notebookId, index === 0); // Set the first tab as active by default
                    });

                    const activeTabUID = getActiveTabUID();
                    if (activeTabUID) {
                        setActiveTab(activeTabUID);
                    } else {
                        setActiveTab(Object.keys(notebooks)[0]);
                    }
                } else {
                    console.log("No notebooks found, creating one..."); // Debug output
                    createNotebook(); // Only create a new notebook if none are found
                }
            }, error => {
                console.error("Failed to fetch notebooks:", error); // Error handling
            });
        }

        function createNotebook() {
            const newNotebookRef = firebase.database().ref(`users/${userId}/notebooks`).push();
            newNotebookRef.set({ createdAt: Date.now() }, function (error) {
                if (!error) {
                    createTab(newNotebookRef.key, true); // Also set this new notebook as active
                }
            });
        }


        function createTab(notebookId, setActive = false) {
            var tab = document.createElement('li');
            tab.className = 'nav-item';
            var link = document.createElement('a');
            link.className = 'nav-link';
            link.href = '#';
            link.textContent = `${notebookId}`;
            link.dataset.notebookId = notebookId;
            link.onclick = function () {
                document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                loadNotes(notebookId);
                saveActiveTabUID(notebookId); // Save the active tab UID whenever a tab is clicked
                return false;
            };
            tab.appendChild(link);
            document.getElementById('notebookTabs').appendChild(tab);
            if (setActive) {
                link.click(); // Automatically click the link to set it as active if specified
            }
        }
        function loadNotes(notebookId) {
            var notebookNotesRef = firebase.database().ref(`users/${userId}/notebooks/${notebookId}/notes`);
            notebookNotesRef.on('value', function (snapshot) {
                const notes = snapshot.val() || {};
                document.getElementById('notesContainer').innerHTML = '';
                Object.keys(notes).forEach(noteId => {
                    var noteElement = document.createElement('div');
                    noteElement.className = 'note';
                    noteElement.textContent = notes[noteId].content;
                    document.getElementById('notesContainer').appendChild(noteElement);
                });
            });
        }

        function addNote(content, notebookId) {
            console.log(`Attempting to add note to notebook ${notebookId}: ${content}`); // Debug output
            var newNoteRef = firebase.database().ref(`users/${userId}/notebooks/${notebookId}/notes`).push();
            newNoteRef.set({ content: content, createdAt: Date.now() }, error => {
                if (error) {
                    console.error('Failed to add note:', error);
                } else {
                    console.log('Note added successfully');
                }
            });
        }
        function setupVoiceRecognition() {
            if (annyang) {
                annyang.setLanguage('cs'); // Set the desired language

                let capturedText = ""; // This will hold the ongoing speech capture
                let silenceTimer; // Timer to handle the end of speaking

                // Function to handle final processing of captured text
                const processCapturedText = () => {
                    const notebookId = document.querySelector('.nav-link.active')?.dataset.notebookId;
                    if (notebookId && capturedText.trim() !== "") {
                        addNote(capturedText, notebookId); // Using the existing addNote function
                        console.log("Note added:", capturedText);
                        capturedText = ""; // Reset the captured text after processing
                    }
                };

                // Append recognized phrases to the captured text
                annyang.addCallback('result', function (phrases) {
                    capturedText += phrases[0] + " ";
                    clearTimeout(silenceTimer); // Reset the timer on new speech detected
                    silenceTimer = setTimeout(processCapturedText, 2000); // Set a new timer for 2 seconds of silence
                });
                SpeechKITT.annyang();
 
                SpeechKITT.setInstructionsText('Co řekneš, zapíšu do poznámky…');
                SpeechKITT.vroom();
            }
        }




    </script>
</body>

</html>